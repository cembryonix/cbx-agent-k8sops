services:
  cbx-agent-k8sops:
    image: "${APP_IMAGE_NAME}"
    container_name: cbx-agent-k8sops
    restart: unless-stopped
    ports:
      - "${APP_PORT}:8000"
    environment:
      - PYTHONPATH=/app
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ${CBX_K8SOPS_CONFIG_DIR:-~/.k8sops}:/root/.k8sops
    depends_on:
      - cbx-mcp-server-k8s

  cbx-mcp-server-k8s:
    image: "${MCP_IMAGE_NAME}"
    container_name: cbx-mcp-server-k8s
    restart: unless-stopped
    ports:
      - "${MCP_PORT}:8080"
    volumes:
      - ${CBX_MCP_KUBECONFIG_DIR}:/home/appuser/.kube:ro
      - ${CBX_MCP_ARGOCD_CONFIG_DIR}:/home/appuser/.config/argocd:ro
    environment:
      - HOME=/home/appuser
    user: "${DOCKER_UID}:${DOCKER_GID}"
